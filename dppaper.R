# Generated by `rjournal_pdf_article()` using `knitr::purl()`: do not edit by hand
# Please edit dppaper.Rmd to modify this file

## ----setup, include=FALSE-----------------------------------------------------
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(ggplot2)
library(kableExtra)
library(tidyverse)
library(knitr)


## ---- echo=TRUE, eval=FALSE---------------------------------------------------
#> new_privacy(post_smpl = NULL, lik_smpl = NULL, ll_priv_mech = NULL,
#>             st_calc = NULL, add = FALSE, npar = NULL)


## ---- echo = TRUE, eval = FALSE-----------------------------------------------
#> dapper_sample(data_model, sdp, nobs, init_par, niter = 2000, warmup = floor(niter / 2),
#>            chains = 1, varnames = NULL)


## ---- echo = FALSE------------------------------------------------------------
set.seed(1)
tmp <- apply(UCBAdmissions, 3, identity, simplify=FALSE)
adm_cnf <- Reduce('+', tmp)
adm_prv <- round(adm_cnf + rnorm(4, mean = 0, sd = 100))


## ---- echo = FALSE------------------------------------------------------------
kbl(list(adm_cnf, adm_prv), booktabs = TRUE) %>%
  kable_styling(position = 'center', latex_options = c("hold_position"))


## ---- echo = FALSE------------------------------------------------------------
#generate 2x2 table data
x <- c(adm_cnf)
sdp <- c(adm_prv)


## ---- echo = TRUE-------------------------------------------------------------
latent_f <- function(theta) {
  t(rmultinom(1, 4526, theta))
}


## ---- echo = TRUE-------------------------------------------------------------
post_f <- function(dmat, theta) {
  x <- c(dmat)
  t1 <- rgamma(length(theta), x + 1, 1)
  t1/sum(t1)
}


## ---- echo = TRUE-------------------------------------------------------------
st_f <- function(dmat) {
  c(dmat)
}


## ---- echo = TRUE-------------------------------------------------------------
priv_f <- function(sdp, x) {
  dnorm(sdp - x, mean = 0, sd = 100, log = TRUE)
}


## ---- echo = TRUE-------------------------------------------------------------
library(dapper)
dmod <- new_privacy(post_f   = post_f,
                    latent_f = latent_f,
                    priv_f   = priv_f,
                    st_f     = st_f,
                    add      = FALSE,
                    npar     = 4,
                    varnames = c("pi_11", "pi_21", "pi_12", "pi_22"))
                  
dp_out <- dapper_sample(dmod,
                  sdp = c(adm_prv),
                  niter = 10000,
                  warmup = 1000,
                  chains = 1,
                  init_par = rep(.25,4))


## ----echo = FALSE-------------------------------------------------------------
summary(dp_out)


## ---- fig.height=3, fig.width=5, fig.align='center'---------------------------
plot(dp_out)


## ---- fig.height=3, fig.width=5, fig.align='center'---------------------------
tv <- dp_out$chain
or <- as.numeric((tv[,1] * tv[,4]) / (tv[,2] * tv[,3]))
quantile(or, c(.025, .50, .975))

ggplot(tibble(x=or), aes(x)) + geom_histogram() + xlim(-1,10)


## ---- echo = FALSE------------------------------------------------------------
or_confint <- function(x, alpha) {
  or <- log(x[1] * x[4]/ (x[2] * x[3]))
  se <- sqrt(sum(1/x))
  c(or - qnorm(alpha/2) * se, or + qnorm(alpha/2) * se)
}

#clean data
exp(or_confint(x, .95))

#privitized data
exp(or_confint(sdp, .95))


## ---- echo = TRUE-------------------------------------------------------------
lik_smpl <- function(theta) {
  t(rmultinom(1, 4526, theta))
}


## ---- echo = TRUE-------------------------------------------------------------
post_smpl <- function(dmat, theta) {
  x <- c(dmat)
  t1 <- rgamma(length(theta), x + 1, 1)
  t1/sum(t1)
}


## ---- echo = TRUE-------------------------------------------------------------
st_calc <- function(dmat) {
  c(dmat)
}


## ---- echo = TRUE-------------------------------------------------------------
ll_priv_mech <- function(sdp, x) {
  dnorm(sdp - x, mean = 0, sd = 100, log = TRUE)
}

